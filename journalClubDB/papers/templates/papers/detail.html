{% extends "base.html" %}

{% block javascript %}
  {% load staticfiles %}
  <script src="{% static 'js/ckeditor/ckeditor.js' %}"></script>
  <script src="{% static 'js/ckeditor/samples/js/sample.js' %}"></script>
  <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
{% endblock %}

{% block body_block %}
  <!-- custom javascript -->
  {% load staticfiles %}
  <script>
    csrf_js = '{{ csrf_token }}'
    url_upvote = "{% url 'papers:upvote' %}"
    url_downvote = "{% url 'papers:downvote' %}"
  </script>
  <script src="{% static "/static/js/detail.js" %}"></script>

  <hr >
  <div class="container">
    <!-- tab bar -->
    <ul class="nav nav-pills nav-justified">
      <li id="pill_0" {% if current_thread == 0 %} class="active" {% endif %}> <a data-toggle="pill" href="#thread_0">Summary</a></li>
      {% for thread in threads %}
        <li id="pill_{{ forloop.counter }}" {% if current_thread == forloop.counter %} class="active" {% endif %}><a data-toggle="pill" href="#thread_{{ forloop.counter }}">{{ thread.title }}</a></li>
      {% endfor %}
    </ul>

    <div class="tab-content">
      <!-- Content for summary jumbotron -->
      <div id="thread_0" {% if current_thread == 0 %} class="tab-pane fade in active" {% else %} class="tab-pane fade" {% endif %}>
        <div id="detail_jumbotron" class="jumbotron">
          <h1>{{ citation.title }}</h1>
          <hr >
          {% load templatetags %} <!-- templatetags cannot be moved to base.html -->
          <p>{{ citation.fullAuthorNames|parse_full_names }}</p>
          <p>{{ citation.fullSource }} </p>
          <hr >
          <p id="detail_abstract"> {{ citation.abstract }} </p>
          <hr >
          <p>Tags:
            {% for associated_tag in associated_tags %}
              <span class="label label-primary">{{ associated_tag }}</span>
            {% endfor %}
          </p>

          <!-- superuser functionality to add tags -->
          {% if user.is_superuser %}
            <hr >
            <form id='form-tag' action="{% url 'papers:add_tag' %}" method=POST>
              {% csrf_token %}
              <input type="hidden" name="citation_pk" value="{{ citation.pk }}" />
              <input type="hidden" name="current_thread" value="0" />
              Add tag: <input type="text" name="tag_name"><br>
              <input type="submit" value="Submit">
            </form>
            Possible tags: <br >
            {% for unused_tag in unused_tags %}
              {{ unused_tag }}, &nbsp;
            {% endfor %}
          {% endif %}

          <hr >
          <p><a class="btn btn-primary btn-tiny" href="http://www.ncbi.nlm.nih.gov/pubmed/{{ citation.pubmedID }}" role="button">pubmed link &raquo;</a></p>
          


        </div>
      </div>



      <!-- message board tabs (ELI5, methodology, etc) -->
      {% for thread,posts,numDepth1Posts in threadsPostsIndents %}
        <div id="thread_{{ forloop.counter }}" {% if current_thread == forloop.counter %} class="tab-pane fade in active" {% else %} class="tab-pane fade" {% endif %}>
          <div class="user_comments">
            <!-- Display number of depth 1 comments, and link for user to submit their own comment -->
            <div class="user_comments_header">
              <h2> {{ numDepth1Posts }} comments </h2>

              {% if user.is_authenticated %}
                <a class='submit'>Add your own comment!</a>
                <form id='formData' action="{% url 'papers:postForm' %}" method=POST>
                  {% csrf_token %}
                  <input type="hidden" name="citation" value="{{ citation.title }}" />
                  <input type="hidden" name="citation_pk" value="{{ citation.pk }}" />
                  <input type="hidden" name="thread_title" value="{{ thread.title }}" />
                  <input type="hidden" name="thread_description" value="{{ thread.description }}" />
                  <input type="hidden" name="thread_pk" value="{{ thread.pk }}" />
                  <input type="hidden" name="isReplyToPost" value="0" />
                  <input type="hidden" name="mother_pk" value="-1" />
                  <input type="hidden" name="current_thread" value="{{ forloop.counter }}" />
                  <input type="hidden" name="initial_text" value="" />
                  <input type="hidden" name="blockquote" value="False" />
                  <input type="hidden" name="edit_or_reply" value="reply" />

                </form>
              {% else %}
                <div class="active modal_item" id="comment-modal"><a id="modal_item1" data-toggle="modal" data-target="#myModal">Add your own comment!</a></div>
              {% endif %}
            </div>

            {% for p in posts %}
              {% if p|is_indent %}
                {% if p|is_depth_one %}
                  <div class="vertical-spacer"></div>
                  <div class="big-box-depth-is-one">
                {% elif p|is_depth_divisible_by_two %}
                  <div class="vertical-spacer"></div>
                  <div class="big-box-depth-divisible-by-two">
                {% else %}
                  <div class="vertical-spacer"></div>
                  <div class="big-box-depth-not-divisible-by-two">
                {% endif %}
              {% elif p|is_dedent %}
                </div>
              {% else %}
                <div id="post_{{ p.pk }}" class="single-post">
                  <table>
                    <tbody>
                      <tr>
                        <!-- interface to vote up or down a comment -->
                        <td class="votecell">
                          <div class="vote">
                            {% if user.is_authenticated %}
                              <input type="hidden" name="post_pk" value="{{ p.pk }}">
                              <a class="vote-up-off" title="This answer is useful" value="{{ p.pk }}">up vote</a>
                            {% else %}
                              <div class="active modal_item" id="upvote-modal"><a class="vote-up-off" id="modal_item1" data-toggle="modal" data-target="#myModal">up vote</a></div>
                            {% endif %}
                            <!--
                            <span itemprop="upvoteCount" class="vote-count-post ">{{ p.score }}</span>
                            -->
                            {% if user.is_authenticated %}
                              <input type="hidden" name="post_pk" value="{{ p.pk }}">
                              <a class="vote-down-off" title="This answer is not useful">down vote</a>
                            {% else %}
                              <div class="active modal_item" id="downvote-modal"><a class="vote-down-off" id="modal_item1" data-toggle="modal" data-target="#myModal">up vote</a></div>
                            {% endif %}



                          </div>
                        </td>
                        <!-- user commment -->
                        <td class="answercell">
                          <span class="comment-user"><a>{{ p.creator.username }}</a></span>
                          , &nbsp;
                          <span id="commentscore-pk-{{ p.pk }}">{{ p.score }}</span> point{{p.score|pluralize}}
                          , &nbsp;
                          {% load templatetags %} <!-- templatetags cannot be moved to base.html -->
                          <span class="comment-time" id="comment-time-{{ p.pk }}">
                            {% if p.get_undecoded_textTupleVector|length == 1 %}
                              posted
                            {% else %}
                              edited
                            {% endif %}
                            {{ p.time_created|age }}
                          </span>
                          <hr >

                          {% for recent_post in p.get_undecoded_textTupleVector %}
                          <div id="comment-text-{{ p.pk }}-{{ forloop.counter }}" class="comment-target-all-{{ p.pk }} comment-all {% if forloop.last %} comment-last {% endif %}">
                            {{ recent_post.0 | safe}} <!-- text -->
                          </div>
                          {% endfor %}

                          <hr >



                          {% if user.is_authenticated %}
                          <span style="float:left;">
                            <a class='submit'>reply</a>
                            <form id='formData' action="{% url 'papers:postForm' %}" method=POST display=inline>
                              {% csrf_token %}
                              <input type="hidden" name="citation" value="{{ citation.title }}" />
                              <input type="hidden" name="citation_pk" value="{{ citation.pk }}" />
                              <input type="hidden" name="thread_title" value="{{ thread.title }}" />
                              <input type="hidden" name="thread_description" value="{{ thread.description }}" />
                              <input type="hidden" name="thread_pk" value="{{ thread.pk }}" />
                              <input type="hidden" name="isReplyToPost" value="1" />
                              <input type="hidden" name="mother_pk" value="{{ p.pk }}" />
                              <input type="hidden" name="current_thread" value="{{ forloop.parentloop.counter }}" />
                              <input type="hidden" name="initial_text" value="{% with p.get_undecoded_textTupleVector|last as recent_post %}
                                                                                {{ recent_post.0 }}
                                                                              {% endwith %}
                                                                              "/>                              <input type="hidden" name="blockquote" value="True" />
                              <input type="hidden" name="post_pk" value="-1" />
                              <input type="hidden" name="edit_or_reply" value="reply" />
                            </form>
                          </span>
                            <!-- allow for editing if user created post TODO: security flaw: check user/post identical in view-->
                            {% if user.get_username == p.creator.username %}

                            <span style="float:left;"> &nbsp; &nbsp; &nbsp;</span>

                            <span style="float:left;">
                              <a class='submit'>edit</a>
                              <form id='formData' action="{% url 'papers:postForm' %}" method=POST>
                                {% csrf_token %}
                                <input type="hidden" name="citation" value="{{ citation.title }}" />
                                <input type="hidden" name="citation_pk" value="{{ citation.pk }}" />
                                <input type="hidden" name="thread_title" value="{{ thread.title }}" />
                                <input type="hidden" name="thread_description" value="{{ thread.description }}" />
                                <input type="hidden" name="thread_pk" value="{{ thread.pk }}" />
                                <input type="hidden" name="isReplyToPost" value="1" />
                                <input type="hidden" name="mother_pk" value="{{ p.pk }}" />
                                <input type="hidden" name="current_thread" value="{{ forloop.parentloop.counter }}" />
                                <input type="hidden" name="initial_text" value="{% with p.get_undecoded_textTupleVector|last as recent_post %}
                                                                                  {{ recent_post.0 }}
                                                                                {% endwith %}
                                                                                "/>
                                <input type="hidden" name="blockquote" value="False" />
                                <input type="hidden" name="post_pk" value="{{ p.pk }}" />
                                <input type="hidden" name="edit_or_reply" value="edit" />
                              </form>
                            </span>
                            {% endif %}


                          {% else %}
                          <span style="float:left;">
                            <div class="active modal_item" id="reply-modal"><a id="modal_item1" data-toggle="modal" data-target="#myModal">reply</a></div>
                          </span>

                          {% endif %}
                          <!-- dropdown to select post history -->
                          <span style="float:left;"> &nbsp; &nbsp; &nbsp;</span>
                          <span style="float:left;">
                            <div class="dropdown">
                                 <a href="#" data-toggle="dropdown" class="dropdown-toggle">history <b class="caret"></b></a>
                                 <ul class="dropdown-menu">
                                   {% for recent_post in p.get_undecoded_textTupleVector %}
                                     <li class="li-dropdown-{{p.pk}} li-dropdown-{{p.pk}}-{{forloop.counter}} {% if forloop.last %} active {% endif %}"><a href="#" id="action-{{ p.pk }}-{{ forloop.counter }}" >
                                       {% if recent_post.3 != p.creator.username %}
                                         recent_post.3
                                       {% endif %}
                                       {% if forloop.counter == 1 %}
                                         posted
                                       {% else %}
                                         edited
                                       {% endif %}
                                       {{ recent_post.2|age }}
                                     </a></li> <!-- time created/edited -->
                                   {% endfor %}
                                 </ul>
                             </div>
                          </span>


                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div> <!-- end div id="post_{{ p.pk }}" -->
              {% endif %}
            {% endfor %} <!-- end loop over posts -->

          </div> <!-- end  <div class="user_comments"> -->
        </div> <!-- div id="thread_{{ forloop.counter }}" -->
      {% endfor %} <!-- end loop over threadsPostsIndents -->
    </div> <!-- end div tab-content -->
  </div> <!-- end div container -->


{% endblock %}
