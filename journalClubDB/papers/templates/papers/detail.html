{% extends "base.html" %}
{% load templatetags %}

{% block javascript %}
  {% load staticfiles %}
  <script src="{% static 'js/ckeditor/ckeditor.js' %}"></script>
  <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <link rel="stylesheet" href="{% static 'css/detail.css' %}">
  <script>
    csrf_js = '{{ csrf_token }}'
    url_upvote = "{% url 'papers:upvote' %}"
    url_downvote = "{% url 'papers:downvote' %}"
  </script>
  <script src="{% static "/static/js/detail.js" %}"></script>
{% endblock %}

{% block body_block %}
  <hr >
  <div class="container">
    <!-- tab bar -->
    <ul class="nav nav-pills nav-justified">
      <li id="pill_0" {% if current_thread == 0 %} class="active" {% endif %}> <a data-toggle="pill" href="#thread_0">Summary</a></li>
      {% for thread in threads %}
        <li id="pill_{{ forloop.counter }}" {% if current_thread == forloop.counter %} class="active" {% endif %}><a data-toggle="pill" href="#thread_{{ forloop.counter }}">{{ thread.title }}</a></li>
      {% endfor %}
      {% if user.is_authenticated %}
        <li id="pill_{{ threads|length|add:1 }}" {% if current_thread == threads|length|add:1 %} class="active" {% endif %}><a data-toggle="pill" href="#thread_{{ threads|length|add:1 }}">Personal notes</a></li>
      {% endif %}
    </ul>

    <div class="tab-content">
      <!-- Content for summary jumbotron -->
      <div id="thread_0" {% if current_thread == 0 %} class="tab-pane fade in active" {% else %} class="tab-pane fade" {% endif %}>
        <div id="detail_jumbotron" class="jumbotron">
          <h1>{{ citation.title }}</h1>
          <hr >
          <p>{{ citation.fullAuthorNames|parse_full_names }}</p>
          <p>{{ citation.fullSource }} </p>
          <hr >
          <p id="detail_abstract"> {{ citation.abstract }} </p>
          <hr >
          <p>Tags:
            {% for associated_tag in associated_tags %}
              <span class="label label-primary">{{ associated_tag }}</span>
            {% endfor %}
          </p>

          <!-- superuser functionality to add tags -->
          {% if user.is_superuser %}
            <hr >
            <form id='form-tag' action="{% url 'papers:add_tag' %}" method=POST>
              {% csrf_token %}
              <input type="hidden" name="citation_pk" value="{{ citation.pk }}" />
              <input type="hidden" name="current_thread" value="0" />
              Add tag: <input type="text" name="tag_name"><br>
              <input type="submit" value="Submit">
            </form>
            Possible tags: <br >
            {% for unused_tag in unused_tags %}
              {{ unused_tag }}, &nbsp;
            {% endfor %}
          {% endif %}
          <hr >

          <!-- buttons to go to pubmed link and add citation to favorites -->
          <a class="btn btn-primary btn-tiny" href="http://www.ncbi.nlm.nih.gov/pubmed/{{ citation.pubmedID }}" role="button">pubmed link &raquo;</a>
          {% if citationIsInLibrary == True %}
            <a class="btn btn-primary btn-tiny" href="{% url 'papers:user_library' %}" role="button">This paper is already in your personal library</a>
          {% else %}
            <a class="btn btn-primary btn-tiny hyperlink-submit-form" role="button">Add paper to your personal library</a>
            <form id='formData' action="{% url 'papers:add_citation_to_user_library' %}" method=POST>
              {% csrf_token %}
              <input type="hidden" name="citation_pk" value="{{ citation.pk }}" />
            </form>
          {% endif %}
        </div>
      </div>

      <!-- message boards  (ELI5, methodology, etc) -->
      {% for thread,posts,numDepth1Posts in threadsPostsIndents %}
        <div id="thread_{{ forloop.counter }}" {% if current_thread == forloop.counter %} class="tab-pane fade in active" {% else %} class="tab-pane fade" {% endif %}>
          <div class="user_comments">
            <!-- Display number of depth 1 comments, and link for user to submit their own comment -->
            <div class="user_comments_header">
              <h2> {{ numDepth1Posts }} comments </h2>

              {% if user.is_authenticated %}
                <a class='hyperlink-submit-form'>Add your own comment!</a>
                <form id='formData' action="{% url 'papers:postForm' %}" method=POST>
                  {% csrf_token %}
                  <input type="hidden" name="citation" value="{{ citation.title }}" />
                  <input type="hidden" name="citation_pk" value="{{ citation.pk }}" />
                  <input type="hidden" name="thread_title" value="{{ thread.title }}" />
                  <input type="hidden" name="thread_description" value="{{ thread.description }}" />
                  <input type="hidden" name="thread_pk" value="{{ thread.pk }}" />
                  <input type="hidden" name="isReplyToPost" value="0" />
                  <input type="hidden" name="mother_pk" value="-1" />
                  <input type="hidden" name="current_thread" value="{{ forloop.counter }}" />
                  <input type="hidden" name="initial_text" value="" />
                  <input type="hidden" name="blockquote" value="False" />
                  <input type="hidden" name="edit_or_reply" value="reply" />
                </form>
              {% else %}
                <div class="active pointer" id="comment-modal"><a id="modal_item1" data-toggle="modal" data-target="#myModal">Add your own comment!</a></div>
              {% endif %}
            </div>

            {% include "post_tree_template.html" %}
          </div> <!-- end  <div class="user_comments"> -->
        </div> <!-- div id="thread_{{ forloop.counter }}" -->
      {% endfor %} <!-- end loop over threadsPostsIndents -->

      <!-- personal notes -->
      {% if user.is_authenticated %}
        <div id="thread_{{ threads|length|add:1 }}" {% if current_thread == threads|length|add:1 %} class="tab-pane fade in active" {% else %} class="tab-pane fade" {% endif %}>
          <div id="detail_jumbotron" class="jumbotron"> <!-- make id unique -->
            <div align="right">
              <a class='hyperlink-submit-form'>edit</a>
              <form id='formData' action="{% url 'papers:personalNoteForm' %}" method=POST>
                {% csrf_token %}
                <input type="hidden" name="citation_pk" value="{{ citation.pk }}" />
              </form>
            </div>
            <div>
              {{ personalNote.text|safe }}
            </div>


          </div>
        </div>
      {% endif %}

    </div> <!-- end div tab-content -->
  </div> <!-- end div container -->


{% endblock %}
